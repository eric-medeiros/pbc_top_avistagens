---
title: "AVISTAGENS - INDIV√çDUOS"
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: fill
    theme: yeti
---

```{r setup, include=FALSE}
library(here)
library(flexdashboard)
library(leaflet)
library(sf)
library(dplyr)
library(stringr)

pasta_output <- here("02_outputs")

# Listar indiv√≠duos

individuos <- list.files(pasta_output, full.names = FALSE) |>
str_remove_all("pontos_|.gpkg") |>
unique()

# Fun√ß√£o para carregar pontos

carregar_pontos <- function(ind) {
caminho <- here(pasta_output, paste0("pontos_", ind, ".gpkg"))
tryCatch(
st_read(caminho, quiet = TRUE) |> st_transform(4326),
error = function(e) NULL
)
}

# Carregar todos os pontos

pontos_individuos <- list()
for (ind in individuos) {
pontos_individuos[[ind]] <- carregar_pontos(ind)
}

# Cores autom√°ticas por indiv√≠duo

cores_individuos <- setNames(
grDevices::hcl.colors(length(individuos), "Dark 3"),
individuos
)

```

```{r}

mapa_base <- leaflet() %>%
  addProviderTiles("CartoDB.Positron", group = "Light") %>%
  addProviderTiles("Esri.WorldImagery", group = "Sat√©lite") %>%
  addScaleBar(position = "bottomleft")

# adicionar pontos: 1 layer por indiv√≠duo
for (ind in individuos) {
  dados <- pontos_individuos[[ind]]
  
  if (!is.null(dados)) {
    mapa_base <- mapa_base %>%
      addCircleMarkers(
        data = dados,
        color = cores_individuos[[ind]],
        fillColor = cores_individuos[[ind]],
        fillOpacity = 0.7,
        radius = 3,
        weight = 1,
        group = ind,   # üëà UM GROUP POR INDIV√çDUO
        popup = ~paste0(
          "<strong>Indiv√≠duo:</strong> ", ind, "<br>",
          "<strong>Data:</strong> ", data, "<br>",
          "<strong>Grupo:</strong> ", grupo, "<br>",
          "<strong>Tamanho grupo:</strong> ",
          ifelse(is.na(tam_grupo), "NA", tam_grupo)
        )
      )
  }
}

# controle de camadas (254 entries)
mapa_base <- mapa_base %>%
  addLayersControl(
    baseGroups = c("Light", "Sat√©lite"),
    overlayGroups = individuos,
    options = layersControlOptions(collapsed = TRUE)
  ) %>%
  hideGroup(individuos)  # üëà come√ßa tudo desligado

mapa_base

```

# Mapa

```{r}
mapa_base
```


# Informa√ß√µes do Mapa
column
-------------

### Legenda por Tipo
- üü° Pontos: Locais de avistagem
- üî¥ Kernel: Densidade de uso
- üîµ P50: √Årea central (50%)
- üü¢ P95: √Årea de uso total (95%)

column
-------------

### Como Usar
1. Selecione um indiv√≠duo no menu acima
2. Use o controle ‚ò∞ para ligar/desligar camadas
3. Comece com "Todos" para ver overview
4. Selecione individual para focar em um

column
-------------

### Infos
- **Total de indiv√≠duos:** `r length(individuos)`
- **Arquivos por indiv√≠duo:**
- Pontos de avistagem (.gpkg)
- Kernel de densidade (.tif)
- Pol√≠gono P50 (.gpkg)
- Pol√≠gono P95 (.gpkg)
- **Sobre a an√°lise:**
- kernel density para padr√µes de uso de espa√ßo de cada indiv√≠duo
- Tipo de suaviza√ß√£o: Normal (gaussiana)
- Par√¢metro sigma da suaviza√ß√£o: 500m